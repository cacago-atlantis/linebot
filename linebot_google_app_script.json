{"files":[{"id":"ad725d5f-0128-42d4-a70d-295c401a8628","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Taipei\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  }\n}"},{"id":"8e3e831a-1757-486f-9cb2-6d62a707115b","name":"linebot_auto_reply_gs_ver","type":"server_js","source":"function doPost(e) {\n\n  // LINE Messenging API Token \n  var CHANNEL_ACCESS_TOKEN \u003d \u0027ae19UEB3fm4w7mdYJ9k9xb6bNrjML1WXVaF89rqzqzswoCOxYY/Xcmpy6yreGcb3wpPnNc+4/YVT0idRouGHCEGDvNsXQrLWZMrRn++CoFoGbiWBDW0wQcMeRd0UEdox2SIGzHWxbIS/+IXWfClQMgdB04t89/1O/w1cDnyilFU\u003d\u0027; \n  \n  // 以 JSON 格式解析 User 端傳來的 e 資料\n  var msg \u003d JSON.parse(e.postData.contents);\n  // msg 格式如下\n  //  var  msg \u003d {\n  //   \"destination\": \"xxxxxxxxxx\",\n  //   \"events\": [\n  //     {\n  //       \"replyToken\": \"xxxxxxxxxx\",\n  //       \"type\": \"memberJoined\",\n  //       \"mode\": \"active\",\n  //       \"timestamp\": 1462629479859,\n  //       \"source\": {\n  //         \"type\": \"group\",\n  //         \"groupId\": \"xxxxxxxxxx\"\n  //       },\n  //       \"webhookEventId\": \"xxxxxxxxxx\",\n  //       \"deliveryContext\": {\n  //         \"isRedelivery\": false\n  //       },\n  //       \"joined\": {\n  //         \"members\": [\n  //           {\n  //             \"type\": \"user\",\n  //             \"userId\": \"xxxxxxxxxx\"\n  //           },\n  //           {\n  //             \"type\": \"user\",\n  //             \"userId\": \"xxxxxxxxxx\"\n  //           }\n  //         ]\n  //       }\n  //     }\n  //   ]\n  // }\n  // for debugging\n  // Logger.log(msg);\n  // console.log(msg);\n\n  /* \n  * LINE API JSON 解析資訊\n  * 部分資訊非共用，要根據 msg_type 來取得資訊\n  * replyToken : 一次性回覆 token\n  * user_id : 使用者 user id，查詢 username 用\n  * userMessage : 使用者訊息，用於判斷是否為預約關鍵字\n  * event_type : 訊息事件類型\n  */\n  const replyToken \u003d msg.events[0].replyToken; //replyToken : 一次性回覆 token\n  const event_type \u003d msg.events[0].source.type; // event_type : 訊息事件類型 group or 單一 user\n  const msg_type \u003d msg.events[0].type; // msg_type : 訊息類別\n    \n  // 必要參數宣告\n  var reply_message \u003d []; // 空白回覆訊息陣列，後期會加入 JSON\n\n  // 判斷是否唯有資訊的 token\n  if (typeof replyToken \u003d\u003d\u003d \u0027undefined\u0027) {\n      return;\n  };\n\n  // 查詢傳訊者的 LINE 帳號名稱\n  function get_user_name(uid) {\n    // 判斷為群組成員還是單一使用者\n    switch (event_type) {\n      case \"user\":\n        var nameurl \u003d \"https://api.line.me/v2/bot/profile/\" + uid;\n        break;\n      case \"group\":\n        var groupid \u003d msg.events[0].source.groupId;\n        var nameurl \u003d \"https://api.line.me/v2/bot/group/\" + groupid + \"/member/\" + uid;\n        break;\n    }\n\n    try {\n      //  呼叫 LINE User Info API，以 user ID 取得該帳號的使用者名稱\n      var response \u003d UrlFetchApp.fetch(nameurl, {\n        \"method\": \"GET\",\n        \"headers\": {\n          \"Authorization\": \"Bearer \" + CHANNEL_ACCESS_TOKEN,\n          \"Content-Type\": \"application/json\"\n        },\n      });\n      var namedata \u003d JSON.parse(response);\n      var reserve_name \u003d namedata.displayName;\n    }\n    catch {\n      reserve_name \u003d \"not avaliable\";\n    }\n    return String(reserve_name)\n  }\n\n  // 將輸入值 word 轉為 LINE 文字訊息格式之 JSON\n  function msg_format(type,word) {\n    let text_json \u003d [{\n      \"type\": type,\n      \"text\": word\n    }]\n    return text_json;\n  }\n\n  // 回傳訊息給line 並傳送給使用者\n  function replay_to_line() {\n    var url \u003d \u0027https://api.line.me/v2/bot/message/reply\u0027;\n    UrlFetchApp.fetch(url, {\n      \u0027headers\u0027: {\n        \u0027Content-Type\u0027: \u0027application/json; charset\u003dUTF-8\u0027,\n        \u0027Authorization\u0027: \u0027Bearer \u0027 + CHANNEL_ACCESS_TOKEN,\n      },\n      \u0027method\u0027: \u0027post\u0027,\n      \u0027payload\u0027: JSON.stringify({\n        \u0027replyToken\u0027: replyToken,\n        \u0027messages\u0027: reply_message,\n      }),\n    });\n  }\n\n  switch (msg_type) {\n\n    case \u0027message\u0027:\n      const userMessage \u003d msg.events[0].message.text;\n      if (userMessage \u003d\u003d \"/抽籤\") {\n        var list1 \u003d [\u0027user_1\u0027, \u0027user_2\u0027, \u0027user_3\u0027, \u0027user_4\u0027] \n        var name \u003d list1[Math.floor((Math.random()*4))]        \n        reply_message \u003d msg_format(\"🃏抽籤!\\n抽到的是\"+name);\n        replay_to_line();\n      }\n      else if (userMessage \u003d\u003d \"/雨神\") {\n        var total_min\u003d8*60-10\n        var delayedDate \u003dnew Date(new Date().setMinutes(new Date().getMinutes() +total_min));\n        var formattedDate \u003d Utilities.formatDate(delayedDate, \"GMT\", \"yyyyMMddHHmm\").toString().substring(0,11)+\u00270\u0027;\n        var png_url\u003d\u0027https://www.cwb.gov.tw/Data/radar/CV1_3600_\u0027+formattedDate+\u0027.png\u0027\n        reply_message \u003d format_message(\"image\",png_url);\n        replay_to_line();\n      }else{\n        //  dosomething\n      } \n    case \u0027memberJoined\u0027:\n      const joinMemberId \u003d msg.events[0].joined.members[0].userId;\n      var user_name \u003d get_user_name(joinMemberId);\n      var welcom_text\u003d\u0027hihi \u0027+user_name+\u0027\\n\u0027    \n      welcom_text+\u003d\u0027歡迎加入群組\u0027\n      reply_message \u003d msg_format(\"text\",welcom_text);\n      replay_to_line();\n      break;\n    // case \u0027leave\u0027:\n    //   do something\n    //   break;\n    // case \u0027memberLeft\u0027:\n    //   do something\n    //   break;\n    //case \u0027postback\u0027:\n    //  do something\n    //  break;\n    // case \u0027join\u0027:\n    //  do something\n    //  break;\n    // case \u0027follow\u0027:\n    //  do something\n    //  break;\n    // case \u0027unfollow\u0027:\n    //  do something\n    //  break;\n    default:\n      break;\n  }\n}"}]}