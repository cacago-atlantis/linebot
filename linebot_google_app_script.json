{"files":[{"id":"ad725d5f-0128-42d4-a70d-295c401a8628","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Taipei\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  }\n}"},{"id":"8e3e831a-1757-486f-9cb2-6d62a707115b","name":"linebot_auto_reply_gs_ver","type":"server_js","source":"function doPost(e) {\n\n  // LINE Messenging API Token \n  var CHANNEL_ACCESS_TOKEN \u003d \u0027ae19UEB3fm4w7mdYJ9k9xb6bNrjML1WXVaF89rqzqzswoCOxYY/Xcmpy6yreGcb3wpPnNc+4/YVT0idRouGHCEGDvNsXQrLWZMrRn++CoFoGbiWBDW0wQcMeRd0UEdox2SIGzHWxbIS/+IXWfClQMgdB04t89/1O/w1cDnyilFU\u003d\u0027; \n  \n  // ä»¥ JSON æ ¼å¼è§£æ User ç«¯å‚³ä¾†çš„ e è³‡æ–™\n  var msg \u003d JSON.parse(e.postData.contents);\n  // msg æ ¼å¼å¦‚ä¸‹\n  //  var  msg \u003d {\n  //   \"destination\": \"xxxxxxxxxx\",\n  //   \"events\": [\n  //     {\n  //       \"replyToken\": \"xxxxxxxxxx\",\n  //       \"type\": \"memberJoined\",\n  //       \"mode\": \"active\",\n  //       \"timestamp\": 1462629479859,\n  //       \"source\": {\n  //         \"type\": \"group\",\n  //         \"groupId\": \"xxxxxxxxxx\"\n  //       },\n  //       \"webhookEventId\": \"xxxxxxxxxx\",\n  //       \"deliveryContext\": {\n  //         \"isRedelivery\": false\n  //       },\n  //       \"joined\": {\n  //         \"members\": [\n  //           {\n  //             \"type\": \"user\",\n  //             \"userId\": \"xxxxxxxxxx\"\n  //           },\n  //           {\n  //             \"type\": \"user\",\n  //             \"userId\": \"xxxxxxxxxx\"\n  //           }\n  //         ]\n  //       }\n  //     }\n  //   ]\n  // }\n  // for debugging\n  // Logger.log(msg);\n  // console.log(msg);\n\n  /* \n  * LINE API JSON è§£æè³‡è¨Š\n  * éƒ¨åˆ†è³‡è¨Šéå…±ç”¨ï¼Œè¦æ ¹æ“š msg_type ä¾†å–å¾—è³‡è¨Š\n  * replyToken : ä¸€æ¬¡æ€§å›è¦† token\n  * user_id : ä½¿ç”¨è€… user idï¼ŒæŸ¥è©¢ username ç”¨\n  * userMessage : ä½¿ç”¨è€…è¨Šæ¯ï¼Œç”¨æ–¼åˆ¤æ–·æ˜¯å¦ç‚ºé ç´„é—œéµå­—\n  * event_type : è¨Šæ¯äº‹ä»¶é¡å‹\n  */\n  const replyToken \u003d msg.events[0].replyToken; //replyToken : ä¸€æ¬¡æ€§å›è¦† token\n  const event_type \u003d msg.events[0].source.type; // event_type : è¨Šæ¯äº‹ä»¶é¡å‹ group or å–®ä¸€ user\n  const msg_type \u003d msg.events[0].type; // msg_type : è¨Šæ¯é¡åˆ¥\n    \n  // å¿…è¦åƒæ•¸å®£å‘Š\n  var reply_message \u003d []; // ç©ºç™½å›è¦†è¨Šæ¯é™£åˆ—ï¼Œå¾ŒæœŸæœƒåŠ å…¥ JSON\n\n  // åˆ¤æ–·æ˜¯å¦å”¯æœ‰è³‡è¨Šçš„ token\n  if (typeof replyToken \u003d\u003d\u003d \u0027undefined\u0027) {\n      return;\n  };\n\n  // æŸ¥è©¢å‚³è¨Šè€…çš„ LINE å¸³è™Ÿåç¨±\n  function get_user_name(uid) {\n    // åˆ¤æ–·ç‚ºç¾¤çµ„æˆå“¡é‚„æ˜¯å–®ä¸€ä½¿ç”¨è€…\n    switch (event_type) {\n      case \"user\":\n        var nameurl \u003d \"https://api.line.me/v2/bot/profile/\" + uid;\n        break;\n      case \"group\":\n        var groupid \u003d msg.events[0].source.groupId;\n        var nameurl \u003d \"https://api.line.me/v2/bot/group/\" + groupid + \"/member/\" + uid;\n        break;\n    }\n\n    try {\n      //  å‘¼å« LINE User Info APIï¼Œä»¥ user ID å–å¾—è©²å¸³è™Ÿçš„ä½¿ç”¨è€…åç¨±\n      var response \u003d UrlFetchApp.fetch(nameurl, {\n        \"method\": \"GET\",\n        \"headers\": {\n          \"Authorization\": \"Bearer \" + CHANNEL_ACCESS_TOKEN,\n          \"Content-Type\": \"application/json\"\n        },\n      });\n      var namedata \u003d JSON.parse(response);\n      var reserve_name \u003d namedata.displayName;\n    }\n    catch {\n      reserve_name \u003d \"not avaliable\";\n    }\n    return String(reserve_name)\n  }\n\n  // å°‡è¼¸å…¥å€¼ word è½‰ç‚º LINE æ–‡å­—è¨Šæ¯æ ¼å¼ä¹‹ JSON\n  function msg_format(type,word) {\n    let text_json \u003d [{\n      \"type\": type,\n      \"text\": word\n    }]\n    return text_json;\n  }\n\n  // å›å‚³è¨Šæ¯çµ¦line ä¸¦å‚³é€çµ¦ä½¿ç”¨è€…\n  function replay_to_line() {\n    var url \u003d \u0027https://api.line.me/v2/bot/message/reply\u0027;\n    UrlFetchApp.fetch(url, {\n      \u0027headers\u0027: {\n        \u0027Content-Type\u0027: \u0027application/json; charset\u003dUTF-8\u0027,\n        \u0027Authorization\u0027: \u0027Bearer \u0027 + CHANNEL_ACCESS_TOKEN,\n      },\n      \u0027method\u0027: \u0027post\u0027,\n      \u0027payload\u0027: JSON.stringify({\n        \u0027replyToken\u0027: replyToken,\n        \u0027messages\u0027: reply_message,\n      }),\n    });\n  }\n\n  switch (msg_type) {\n\n    case \u0027message\u0027:\n      const userMessage \u003d msg.events[0].message.text;\n      if (userMessage \u003d\u003d \"/æŠ½ç±¤\") {\n        var list1 \u003d [\u0027user_1\u0027, \u0027user_2\u0027, \u0027user_3\u0027, \u0027user_4\u0027] \n        var name \u003d list1[Math.floor((Math.random()*4))]        \n        reply_message \u003d msg_format(\"ğŸƒæŠ½ç±¤!\\næŠ½åˆ°çš„æ˜¯\"+name);\n        replay_to_line();\n      }\n      else if (userMessage \u003d\u003d \"/é›¨ç¥\") {\n        var total_min\u003d8*60-10\n        var delayedDate \u003dnew Date(new Date().setMinutes(new Date().getMinutes() +total_min));\n        var formattedDate \u003d Utilities.formatDate(delayedDate, \"GMT\", \"yyyyMMddHHmm\").toString().substring(0,11)+\u00270\u0027;\n        var png_url\u003d\u0027https://www.cwb.gov.tw/Data/radar/CV1_3600_\u0027+formattedDate+\u0027.png\u0027\n        reply_message \u003d format_message(\"image\",png_url);\n        replay_to_line();\n      }else{\n        //  dosomething\n      } \n    case \u0027memberJoined\u0027:\n      const joinMemberId \u003d msg.events[0].joined.members[0].userId;\n      var user_name \u003d get_user_name(joinMemberId);\n      var welcom_text\u003d\u0027hihi \u0027+user_name+\u0027\\n\u0027    \n      welcom_text+\u003d\u0027æ­¡è¿åŠ å…¥ç¾¤çµ„\u0027\n      reply_message \u003d msg_format(\"text\",welcom_text);\n      replay_to_line();\n      break;\n    // case \u0027leave\u0027:\n    //   do something\n    //   break;\n    // case \u0027memberLeft\u0027:\n    //   do something\n    //   break;\n    //case \u0027postback\u0027:\n    //  do something\n    //  break;\n    // case \u0027join\u0027:\n    //  do something\n    //  break;\n    // case \u0027follow\u0027:\n    //  do something\n    //  break;\n    // case \u0027unfollow\u0027:\n    //  do something\n    //  break;\n    default:\n      break;\n  }\n}"}]}